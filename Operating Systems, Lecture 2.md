# Домашнее задание к занятию "3.4. Операционные системы, лекция 2"


1.На лекции мы познакомились с node_exporter. В демонстрации его исполняемый файл запускался в background.
Этого достаточно для демо, но не для настоящей production-системы, где процессы должны находиться под внешним
управлением. Используя знания из лекции по systemd, создайте самостоятельно простой unit-файл для node_exporter:
поместите его в автозагрузку,  
предусмотрите возможность добавления опций к запускаемому процессу через внешний файл  
(посмотрите, например, на systemctl cat cron),  
удостоверьтесь, что с помощью systemctl процесс корректно стартует, завершается, а после перезагрузки автоматически
поднимается.  
Ответ: Установил настроил node_exporter [скрин_1 ](https://drive.google.com/file/d/1nYuBTkPdTafEc1seiHw_HXEzurp7740v/view?usp=sharing) 
[скрин_2](https://drive.google.com/file/d/1zs80gTY5sBS6gNKV3VrANajE7U48bO1c/view?usp=sharing)  
После перезагрузки результат тот же, сервис работает.  

2. Ознакомьтесь с опциями node_exporter и выводом /metrics по-умолчанию.  
Приведите несколько опций, которые вы бы выбрали для базового мониторинга хоста по CPU, памяти, диску и сети.  
Ответ:  [скрин_3](https://drive.google.com/file/d/1EVefgNQupVkGvA1JmGlRg-WizITuaITW/view?usp=sharing)
CPU: system, user покажут время, использованное системой и программами; слишком высокий steal будет означать,
   что гипервизор перегружен и процессор занят другими ВМ; iowait - поможет отследить, всё ли в порядке с дисковой системой.  
MEM: MemTotal - количество памяти; MemFree и MemAvailable - свободная и доступная память [скрин_4](https://drive.google.com/file/d/1EjqBeu-inQeVwOv5w8mlCrf_ynUk6mba/view?usp=sharing)  
DISK: size_bytes и avail_bytes покажут объём и свободное место; readonly=1 может говорить о проблемах ФС [скрин_5](https://drive.google.com/file/d/1f9KMJed4hDh3Umm1InM8Q_HKwagBYLRR/view?usp=sharing)  
3. Установите в свою виртуальную машину Netdata. Воспользуйтесь готовыми пакетами для установки 
(sudo apt install -y netdata). После успешной установки:  
 в конфигурационном файле /etc/netdata/netdata.conf в секции [web] замените значение с localhost на bind to = 0.0.0.0,  
 добавьте в Vagrantfile проброс порта Netdata на свой локальный компьютер и сделайте vagrant reload:  
`config.vm.network "forwarded_port", guest: 19999, host: 19999`  
После успешной перезагрузки в браузере на своем ПК (не в виртуальной машине) вы должны суметь зайти на localhost:19999. 
Ознакомьтесь с метриками, которые по умолчанию собираются Netdata и с комментариями, которые даны к этим метрикам.  
Ответ: Установил настроил [скриншот_6](https://drive.google.com/file/d/1d1K71fXejgdAPbBiet5oMjDPGps7nypp/view?usp=sharing)  
4. Можно ли по выводу dmesg понять, осознает ли ОС, что загружена не на настоящем оборудовании,  
а на системе виртуализации?  
Ответ: да. Например, Vagrant в VirtualBox на Windows: [скрин_7](https://drive.google.com/file/d/1WTTYr1hCULaZd3kux8oIBmI9oB6Nwbwr/view?usp=sharing)  
5. Как настроен sysctl fs.nr_open на системе по-умолчанию? Узнайте, что означает этот параметр.  
Какой другой существующий лимит не позволит достичь такого числа (ulimit --help)?  
Ответ: [скрин_8](https://drive.google.com/file/d/1w6Zdzj8pRPIB_wLqc_b6BhNp2HEdeh2t/view?usp=sharing)  
**fs.nr_open** - жесткий лимит на открытые дескрипторы для ядра (системы)  
**Soft limit** на пользователя, может быть изменен как большую, так и меньшую сторону  
**Hard limit** на пользователя, может быть изменен только в меньшую сторону
Оба ulimit -n не могут превышать **fs.nr_open**    
6. Запустите любой долгоживущий процесс (не ls, который отработает мгновенно, а, например, sleep 1h)  
в отдельном неймспейсе процессов; покажите, что ваш процесс работает под PID 1 через nsenter.   
Для простоты работайте в данном задании под root (sudo -i). Под обычным пользователем требуются  
дополнительные опции (--map-root-user) и т.д.  
Ответ: [скрин_9](https://drive.google.com/file/d/1d0QNpjNMG4dqRXrlIIflUlV88o6WpXEJ/view?usp=sharing)  
7. Найдите информацию о том, что такое :(){ :|:& };:. Запустите эту команду в своей виртуальной машине  
Vagrant с Ubuntu 20.04 (это важно, поведение в других ОС не проверялось). Некоторое время все будет "плохо",
после чего (минуты) – ОС должна стабилизироваться. Вызов dmesg расскажет, какой механизм помог автоматической
стабилизации. Как настроен этот механизм по-умолчанию, и как изменить число процессов, которое можно создать в сессии?  
Ответ: Это fork bomb, бесконечно создающая свои копии (системным вызовом fork())  
Стабилизации системы  [скрин_10 ](https://drive.google.com/file/d/19JBeO76xhlNloBN7KCXoIIFsPDoyijlM/view?usp=sharing)  
Значение TasksMax (изменение значения в %, конкретное число или infinity, чтобы убрать лимит)  
в /usr/lib/systemd/system/user-.slice.d/10-defaults.conf регулирует число процессов, которое можно создать в сессии
